#!/bin/bash

FAILURE=
SRC=$(realpath .)
TESTS=$(realpath tests)

for test in $TESTS/*.sh; do
  echo -n ${test##*/}
  workdir=$(mktemp -d)
  cp -R ./tests/fixture $workdir
  pushd $workdir/fixture > /dev/null
  git init --quiet
  git add .
  git commit -m "Initial commit" --quiet
  PATH=$PATH:$SRC /bin/sh $test > $test.actual.output
  git diff --unified=0 \
    | sed -e '/^index/d' \
    > $test.actual.diff
  popd > /dev/null
  if [ -f $test.expected.diff ]; then
    sed -i.bak 's/[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]/2000-01-01/g' $test.actual.diff
    diff $test.expected.diff $test.actual.diff
  else
    diff $test.expected.output $test.actual.output
  fi
  if [[ $? != 0 ]]; then
    FAILURE="true"
    echo " ðŸ”´"
  else
    echo " âœ…"
  fi
done

test -z $FAILURE
